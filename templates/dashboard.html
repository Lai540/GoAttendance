<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .sidebar { min-height: 100vh; overflow-y: auto; }
        .nav-link.active { background-color: #6c757d; font-weight: bold; border-radius: 0.25rem; }
        .card h5 { font-weight: bold; }
        .card { display: flex; flex-direction: column; height: 100%; }
        .card-body { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .chart-container { position: relative; height: 350px; width: 100%; }
        .attendance-status { position: fixed; bottom: 10px; right: 20px; z-index: 1050; min-width: 250px; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav class="col-md-3 col-lg-2 bg-dark text-white sidebar p-3">
            <h3 class="mb-4">GoAttendance</h3>
            <ul class="nav flex-column">
                <li class="nav-item mb-2">
                    <a href="{{ url_for('dashboard') }}" class="nav-link text-white active">üè† Dashboard</a>
                </li>
                <li class="nav-item mb-2">
                    <!-- Sign In Attendance -->
                    <form method="POST" action="{{ url_for('sign_in_attendance') }}">
                        <button type="submit" class="btn btn-success w-100 text-start">‚úÖ Sign In Attendance</button>
                    </form>
                </li>
                <li class="nav-item mb-2">
                    <a href="{{ url_for('logout', staff_id=staff.staff_id) }}" class="nav-link text-white">üö™ Sign Out Attendance</a>
                </li>
                {% if staff.is_admin %}
                <li class="nav-item mb-2">
                    <a href="{{ url_for('admin_dashboard') }}" class="nav-link text-white fw-bold bg-secondary rounded">‚öô Admin Panel</a>
                </li>
                {% endif %}
                <li class="nav-item mb-2">
                    <a href="{{ url_for('logout_session') }}" class="nav-link text-white">üîë Logout</a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 col-lg-10 p-4">
            <h2 class="mb-4">Welcome, {{ staff.name }}</h2>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, msg in messages %}
                  <div class="alert alert-{{ 'danger' if category=='danger' else 'success' }} alert-dismissible fade show" role="alert">
                    {{ msg }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <!-- Quick Actions -->
            <h4 class="mb-3">‚ö° Quick Actions</h4>
            <div class="row g-3 mb-4">
                <!-- Sign In Card -->
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Sign In Attendance</h5>
                            <p class="card-text">Click to sign in now.</p>
                            <form method="POST" action="{{ url_for('sign_in_attendance') }}">
                                <button type="submit" class="btn btn-success w-100">‚úÖ Sign In</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Sign Out Card -->
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Sign Out Attendance</h5>
                            <p class="card-text">Click to sign out when leaving.</p>
                            <a href="{{ url_for('logout', staff_id=staff.staff_id) }}" class="btn btn-danger w-100">üö™ Sign Out</a>
                        </div>
                    </div>
                </div>

                <!-- Change Password Card -->
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-center">Change Password</h5>
                            <form method="POST" class="flex-grow-1 d-flex flex-column justify-content-between">
                                <div class="mb-3">
                                    <input type="password" class="form-control" name="new_password" id="new_password" placeholder="Enter new password" required>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" class="form-check-input" onclick="toggleNewPassword()">
                                        <label class="form-check-label">Show Password</label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">üîë Change Password</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Admin Panel Card -->
                {% if staff.is_admin %}
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body text-center">
                            <h5 class="card-title">Admin Panel</h5>
                            <p class="card-text">Manage reports & staff activity.</p>
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary w-100">‚öô Go to Admin</a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Learners Data -->
            <h4 class="mb-3">üìä Learners Data</h4>
            {% if learners %}
            <div class="row g-3 mb-4">
                <div class="col-md-6 col-lg-4">
                    <div class="card shadow-sm border-0 text-center h-100">
                        <div class="card-body">
                            <h5 class="card-title">Total Learners Population</h5>
                            <p class="card-text fs-3 fw-bold text-success">{{ total_population }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <h5 class="card-title text-center">Learners Enrollment by Gender</h5>
                            <div class="chart-container">
                                <canvas id="learnersChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <h5 class="card-title text-center">Gender Distribution</h5>
                            <div class="chart-container">
                                <canvas id="genderPieChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">No learners data available. Please contact admin.</div>
            {% endif %}
        </main>
    </div>
</div>

<!-- Attendance Status Floating -->
<div class="attendance-status alert alert-{{ 'success' if staff.attendance_active else 'warning' }}">
    {% if staff.attendance_active %}
        ‚úÖ You are currently logged in
    {% else %}
        ‚ö† You are not logged in
    {% endif %}
</div>

<script>
    function toggleNewPassword() {
        var x = document.getElementById("new_password");
        x.type = (x.type === "password") ? "text" : "password";
    }

    {% if learners %}
    new Chart(document.getElementById('learnersChart'), {
        type: 'bar',
        data: {
            labels: {{ categories|tojson }},
            datasets: [
                { label: 'Girls', data: {{ girls_counts|tojson }}, backgroundColor: 'rgba(255, 99, 132, 0.7)' },
                { label: 'Boys', data: {{ boys_counts|tojson }}, backgroundColor: 'rgba(54, 162, 235, 0.7)' }
            ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
    });

    new Chart(document.getElementById('genderPieChart'), {
        type: 'pie',
        data: {
            labels: ['Girls', 'Boys'],
            datasets: [{
                data: [{{ girls_counts|sum }}, {{ boys_counts|sum }}],
                backgroundColor: ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)'],
                borderColor: '#fff', borderWidth: 2
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
    {% endif %}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>